stages:
  - build
  - deploy
  - smoke

variables:
  GCP_PROJECT_NAME: $MY_GCP_PROJECT
  GCP_REGION: europe-west1-b
  CLUSTER_NAME: $MY_K8S_CLUSTER_NAME
  NAMESPACE: alexos
  DOMAIN: alexos.dev
  IMAGE_NAME: eu.gcr.io/${MY_GCP_PROJECT}/alexos

build:
  stage: build
  image: mosstech/gcloud-and-docker:318.0.0
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    GOOGLE_CREDENTIALS: $GCR_CREDENTIALS
  services:
    - docker:dind
  only:
    - master
  script:
    - ./go build

deploy:
  stage: deploy
  image: mosstech/ci-tools:latest
  variables:
    GOOGLE_CREDENTIALS: $K8S_CREDENTIALS
  dependencies:
    - build
  only:
    - master
  script:
    - ./go deploy

smoke:
  stage: smoke
  image: mosstech/ci-tools:latest
  dependencies:
    - deploy
  only:
    - master
  script:
    - ./go smoke
