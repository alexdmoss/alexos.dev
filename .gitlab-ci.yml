stages:
  - build
  - deploy
  - smoke

variables:
  GCP_PROJECT_NAME: moss-work
  GCP_REGION: europe-west1-b
  CLUSTER_NAME: mw-prod
  GOOGLE_CREDENTIALS: $BUILD_KEY
  NAMESPACE: mosstech
  APP_NAME: mosstech
  DOMAIN: mosstech.io

build:
  stage: build
  image: registry.gitlab.com/mosstech/mw-platform/mw-builder
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
  services:
    - docker:dind
  only:
    - master
  script:
    - ./go build

deploy:
  stage: deploy
  image: registry.gitlab.com/mosstech/mw-platform/mw-builder
  dependencies:
    - build
  only:
    - master
  script:
    - ./go deploy

smoke:
  stage: smoke
  image: registry.gitlab.com/mosstech/mw-platform/mw-builder
  dependencies:
    - deploy
  only:
    - master
  script:
    - ./go smoke
